#!/usr/bin/env python

import webapp2
import jinja2
import os

from objects.usermeta import UserMeta
from objects.game import Game
from utilities import *
from google.appengine.api import users
from google.appengine.ext import db

jinja_environment = jinja2.Environment(loader=jinja2.FileSystemLoader(os.path.dirname(__file__)))

class ViewHandler(webapp2.RequestHandler):
  def get(self,game_id=None):
    game=Game.get_by_id(int(game_id))
    if game_id:
      game=Game.get_by_id(int(game_id))
    else:
      game=next_game()
    players=game.playergame_set
    template_values={'game':game,
        'batsmen':sorted(players,key=lambda player: player.batting_position),
        'bowlers':sorted(players,key=lambda player: player.bowling_position),
        'fielders':players}
        
    template=jinja_environment.get_template('templates/game.html')
    self.response.out.write(template.render(template_values))

class ListHandler(webapp2.RequestHandler):
  def get(self):
    next=next_game()
    template_values={'next_game':next,'lockout':lockout()}
    template_values['future_games']=Game.all().filter('round >',next.round).run()
    template_values['past_games']=Game.all().filter('round <',next.round).run()
    
    template=jinja_environment.get_template('templates/games.html')
    self.response.out.write(template.render(template_values))

app = webapp2.WSGIApplication([webapp2.Route('/games/<game_id>',handler=ViewHandler),
                              ('/games',ListHandler)],debug=True)